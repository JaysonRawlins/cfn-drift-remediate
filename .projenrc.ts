import { typescript, TextFile } from 'projen';
import { GithubCredentials } from 'projen/lib/github';
import { NpmAccess } from 'projen/lib/javascript';

const minNodeVersion = '20.19.0';

const project = new typescript.TypeScriptProject({
  name: '@jjrawlins/cfn-drift-remediate',
  description: 'CLI tool to remediate CloudFormation drift by re-importing drifted resources with their actual state',
  packageName: '@jjrawlins/cfn-drift-remediate',
  authorName: 'Jayson Rawlins',
  authorEmail: 'jayson.rawlins@gmail.com',
  license: 'Apache-2.0',
  repository: 'https://github.com/JaysonRawlins/cfn-drift-remediate.git',
  defaultReleaseBranch: 'main',
  minNodeVersion: minNodeVersion,
  projenrcTs: true,

  // CLI bin entry point
  bin: {
    'cfn-drift-remediate': 'lib/index.js',
  },

  // NPM Publishing via OIDC trusted publishing (beta dist-tag)
  releaseToNpm: true,
  npmAccess: NpmAccess.PUBLIC,
  npmDistTag: 'beta',
  npmTrustedPublishing: true,

  // GitHub Options
  githubOptions: {
    projenCredentials: GithubCredentials.fromApp({
      appIdSecret: 'PROJEN_APP_ID',
      privateKeySecret: 'PROJEN_APP_PRIVATE_KEY',
    }),
    mergify: false,
    pullRequestLintOptions: {
      semanticTitleOptions: {
        types: ['feat', 'fix', 'docs', 'style', 'refactor', 'perf', 'test', 'chore', 'revert', 'ci', 'build', 'deps', 'wip', 'release'],
      },
    },
  },

  // Runtime Dependencies
  deps: [
    '@aws-sdk/client-cloudformation',
    '@aws-sdk/credential-providers',
    'commander',
    'yaml-cfn',
    'chalk',
    'ora',
    '@inquirer/prompts',
  ],

  // Dev Dependencies
  devDeps: [
    '@types/node',
    '@types/js-yaml',
  ],

  // TypeScript configuration
  tsconfig: {
    compilerOptions: {
      esModuleInterop: true,
      types: ['node'],
    },
  },
  tsconfigDev: {
    compilerOptions: {
      types: ['node', 'jest'],
    },
  },

  // Jest configuration - exclude integration tests by default
  jestOptions: {
    jestConfig: {
      testPathIgnorePatterns: ['/node_modules/', '/test/integration/'],
    },
  },
});

// Release workflow overrides for OIDC trusted publishing
const releaseWorkflow = project.github!.tryFindWorkflow('release')!;
releaseWorkflow.file!.addOverride('jobs.release.permissions.id-token', 'write');
releaseWorkflow.file!.addOverride('jobs.release.permissions.contents', 'write');
releaseWorkflow.file!.addOverride('jobs.release_npm.permissions.id-token', 'write');
releaseWorkflow.file!.addOverride('jobs.release_npm.permissions.contents', 'write');
// Override node-version to 24 for npm trusted publishing (requires npm 11.5.1+)
releaseWorkflow.file!.addOverride('jobs.release_npm.steps.0.with.node-version', '24');
// Add --ignore-engines to yarn install since Node 24 is outside the engines range (20.x)
releaseWorkflow.file!.addOverride('jobs.release_npm.steps.4.run',
  'cd .repo && yarn install --check-files --frozen-lockfile --ignore-engines');

// .tool-versions file for asdf
new TextFile(project, '.tool-versions', {
  lines: [
    '# ~~ Generated by projen. To modify, edit .projenrc.ts and run "npx projen".',
    `nodejs ${minNodeVersion}`,
    'yarn 1.22.22',
  ],
});

// Exclude integration test CDK app from ESLint (has its own dependencies)
project.eslint?.addIgnorePattern('test/integration/');

// Ignore runtime backup files created by cfn-drift-remediate
project.gitignore.addPatterns('.cfn-drift-remediate-backup-*');
project.npmignore?.addPatterns('.cfn-drift-remediate-backup-*');

project.synth();
